# ğŸ—ï¸ ARCHITECT - Tá»­ Vi LÃ¡ Sá»‘

## Kiáº¿n trÃºc Tá»•ng quan

**Single Container Architecture** - Táº¥t cáº£ trong 1 Docker container.

```
Browser (HTML/JS)
    â†“ HTTP
Express Server (Port 8950)
    â”œâ”€ Static files (/public)
    â”œâ”€ API routes (/api/*)
    â””â”€ Middleware (auth, rate limit)
    â†“
SQLite (data/tuvi.db)
    â†“
Gemini API (external)
```

## Cáº¥u trÃºc ThÆ° má»¥c

```
tu-vi-la-so/
â”œâ”€â”€ .agent/              # Agent instructions
â”œâ”€â”€ server/              # Backend (Express)
â”œâ”€â”€ public/              # Frontend (static)
â”œâ”€â”€ data/                # SQLite database (volume)
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ Dockerfile
â””â”€â”€ .env
```

## Database Schema

```sql
-- users
CREATE TABLE users (
  id INTEGER PRIMARY KEY,
  username TEXT UNIQUE,
  email TEXT UNIQUE,
  password TEXT,  -- bcrypt hash
  created_at DATETIME
);

-- analysis_history (future)
CREATE TABLE analysis_history (
  id INTEGER PRIMARY KEY,
  user_id INTEGER,
  birth_data TEXT,  -- JSON
  analysis_result TEXT,  -- JSON
  created_at DATETIME
);
```

## API Design

```
POST /api/auth/register   # ÄÄƒng kÃ½
POST /api/auth/login      # ÄÄƒng nháº­p
GET  /api/auth/me         # Current user (protected)
POST /api/ai/analyze      # PhÃ¢n tÃ­ch AI (protected)
GET  /api/health          # Healthcheck
```

## Data Flow

### 1. Registration/Login
```
Browser â†’ POST /api/auth/register
        â†’ Validate â†’ Hash password â†’ Insert DB
        â†’ Return JWT â†’ Store localStorage
```

### 2. Tá»­ Vi Calculation
```
Browser â†’ Input birth data
        â†’ tu-vi-calc.js (client-side)
        â†’ Render chart (no API call)
```

### 3. AI Analysis
```
Browser â†’ POST /api/ai/analyze + JWT
        â†’ authMiddleware verify
        â†’ Call Gemini API
        â†’ Return result
```

## Logic Engine Architecture (v2.0)

### Event Scanner Pipeline
```
tu-vi-calc.js  â†’  tu-vi-sao.js  â†’  tu-vi-event-scanner.js  â†’  tu-vi-interpret.js
  (tÃ­nh toÃ¡n)     (an sao)         (quÃ©t sá»± kiá»‡n)              (tá»•ng há»£p luáº­n giáº£i)
      â†“               â†“                  â†“                          â†“
   lasoData        saoMap          events[]                  interpretation
                                   (scored, sorted)           + events
                                        â†“
                                  server/gemini.js
                                   (AI luáº­n sÃ¢u)
```

### Data Files
```
public/
â”œâ”€â”€ tu-vi-event-rules.js      # 26 event rules (4 categories)
â”œâ”€â”€ tu-vi-star-patterns.js     # Bá»™ sao káº¿t há»£p + miáº¿u/hÃ£m 14 tinh
â”œâ”€â”€ tu-vi-templates.js         # Templates lá»i luáº­n giáº£i
â””â”€â”€ tu-vi-event-scanner.js     # Logic engine: scan() â†’ events
```

### Knowledge Base
```
.agent/knowledge/tu-vi-logic-engine.md  # Full reference
```

## Security Architecture

1. **Auth:** JWT (7 days expire) + bcrypt (10 rounds)
2. **Validation:** Client + Server
3. **Rate Limiting:** 5 req/min (AI), 5 req/15min (Auth)
4. **HTTPS:** Production only (Nginx reverse proxy)

## Performance

- **Calculation:** Client-side (khÃ´ng tá»‘n server)
- **Static files:** Express.static vá»›i cache 1 day
- **AI caching:** Future enhancement

## Deployment

```
Nginx (tuvi.demowebest.site)
  â†“ proxy_pass
Docker Container (localhost:8950)
  â†“ volume mount
SQLite (./data/tuvi.db)
```

## Constraints

### DO's âœ…
- Single container
- Client-side calculation
- SQLite database
- JWT authentication
- Port 8950 (KHÃ”NG Ä‘á»•i)

### DON'Ts âŒ
- KHÃ”NG microservices
- KHÃ”NG PostgreSQL/MySQL
- KHÃ”NG Redis (chÆ°a cáº§n)
- KHÃ”NG React/Vue
- KHÃ”NG thay Ä‘á»•i port

## Decision Log

| Decision | Rationale |
|----------|-----------|
| Single container | Dá»± Ã¡n nhá», Ä‘Æ¡n giáº£n |
| SQLite | File-based, Ä‘á»§ performance |
| Vanilla JS | KhÃ´ng cáº§n build step |
| JWT | Stateless auth |
| Port 8950 | Production Ä‘Ã£ deploy |
